name: Close Translation Pull Requests

on:
  pull_request:
    branches: [ main ]

jobs:

  close-translation-prs:
    if: github.actor != 'weblate' && github.repository == 'MikeSiLVO/script.skinshortcuts'

    name: Close Translation Pull Requests
    runs-on: ubuntu-latest

    steps:
      - name: Check and close translation PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const hasEnGb = files.some(f => f.filename.includes('en_gb/strings.po'));
            const hasStrings = files.some(f => f.filename.includes('strings.po'));

            // Allow if en_gb was modified (likely valid PR) or no strings.po at all
            if (hasEnGb || !hasStrings) {
              console.log('Not a translation-only PR, allowing through');
              return;
            }

            // Close translation PRs from non-Weblate contributors
            console.log('Translation PR detected, closing');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `A modified strings.po file was detected.

            Translations are not accepted through PRs, please use Weblate if you'd like to contribute to the translations.

            If you feel this PR was closed in error, please reply below.
            Thank you for your interest in improving this add-on.`
            });

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              state: 'closed'
            });
